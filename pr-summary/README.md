# AI-assisted GitHub Actions for Pull-Request Summaries

_Boost your workflow with AI-generated, concise pull request summaries. Save time and enhance team collaboration directly within GitHub._

This GitHub Action will generate an AI-created summary of a pull request, providing an overview of the changes and key points.
Please be aware that any summaries generated by the AI should be considered as informative guidance and not definitive conclusions.

### How It Works

1. The action captures the diff (added, removed, and modified content) of a pull request.
2. This diff is sent to the _SAP AI Core_ service, which employs a [generative AI model](https://help.sap.com/docs/sap-ai-core/sap-ai-core-service-guide/model-configuration) to create a summary.
3. The summary is then posted as a comment in the pull request.

## Requirements and Setup

To get started, you'll need to configure both _GitHub Actions_ and _SAP AI Core_.

1.  Activate **[GitHub Actions](https://github.com/features/actions)** for your repo

2.  Create **[SAP AI Core Deployment for Orchestration](https://help.sap.com/docs/sap-ai-core/sap-ai-core-service-guide/create-deployment-for-generative-ai-model-in-sap-ai-core)** and get your service key.

3.  Store the full service key in a [GitHub secret](https://docs.github.com/en/actions/security-for-github-actions/security-guides/using-secrets-in-github-actions#creating-secrets-for-a-repository) (e.g., `AICORE_SERVICE_KEY`).

    <details>
       <summary>The service key looks like this (click to expand)</summary>

    ```json
    {
      "serviceurls": {
        "AI_API_URL": "..."
      },
      "appname": "...",
      "clientid": "...",
      "clientsecret": "...",
      "identityzone": "...",
      "identityzoneid": "...",
      "url": "..."
    }
    ```

    </details>

4.  Create a [workflow file](https://docs.github.com/de/actions/get-started/quickstart) in your repository with a workflow configuration that uses this action.

## Usage

To include this action in a workflow, use the following syntax:

```yaml
uses: SAP/ai-assisted-github-actions/pr-summary@v3
```

The action is available in these GitHub Enterprise Server instances:

- github.tools.sap
- github.wdf.sap.corp
- github.concur.com

### Minimal Example

Create a file `.github/workflows/ai-assistance.yml` with the content below:

```yaml
name: AI-assisted
on:
  pull_request:
    types: [ready_for_review]

jobs:
  summary:
    name: PR Summary
    runs-on: [solinas]
    steps:
      - uses: SAP/ai-assisted-github-actions/pr-summary@v3
        with:
          aicore-service-key: ${{ secrets.AICORE_SERVICE_KEY }}
```

This example triggers the action when a pull request transitions from _draft_ to _ready for review_.

> **Note**: Here, the workflow trigger event is `ready_for_review` needs an explicit status transition from _draft_ to _ready to review_ in a PR. Just creating a PR (which is already in _ready-to-review_ status) won't be enough to trigger the workflow.
>
> If you click on _convert to draft_ and then click _ready to review_, the workflow should be triggered. Alternatively, you could use a different trigger that [looks for a specific user that is requested for a review](#review-requested-for-specific-user).

It will create a summary of the pull request as a comment. Please be aware that any summaries generated by the AI should be considered as informative guidance and not definitive conclusions.

- The `aicore-service-key` should be a valid service key for your _SAP AI Core_ service instance.
- Since no `user-token` is provided, the action will use the default GitHub token (usually the _github-actions[bot]_ user).

### Parameters

Input parameters for the action:

| Name                            | Description                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| ------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| `aicore-service-key` (required) | The service key for your _SAP AI Core_ service instance.                                                                                                                                                                                                                                                                                                                                                                                         |
| `display-mode`                  | Defines where the summary will be posted. Default: `comment` <ul><li>`comment`: Adds a new comment with the summary.</li><li>`comment-delta`: Adds a comment with only the changes made since the last summary.</li><li>`append`: Appends the summary to the PR description text (`header-text`/`footer-text` could be useful to distinguish it from default PR text)</li><li>`none`: No display; the action will not post any summary</li></ul> |
| `user-token`                    | The personal access token of the GitHub user that is used to create the summary. <br /> Default: `${{ github.token }}`                                                                                                                                                                                                                                                                                                                           |
| `model`                         | The name of the SAP AI Core model that is used to generate the summary. <br /> Default: `gpt-4`                                                                                                                                                                                                                                                                                                                                                  |
| `model-parameters`              | Additional parameters for the model as JSON. For example, `{"temperature": 0.5, "max_tokens": 100}`. <br /> Default: `{}`                                                                                                                                                                                                                                                                                                                        |
| `model-version`                 | The version of the model that is used to generate the summary. <br /> Default: `latest`                                                                                                                                                                                                                                                                                                                                                          |
| `deployment-config`             | The deployment configuration as JSON. For example, {\"resourceGroup\": \"abcdefg\"}. <br /> Default: `{}`                                                                                                                                                                                                                                                                                                                                        |
| `show-model-metadata-footer`    | Whether to show the model metadata (such as model name and token usage) in the footer of the summary. <br /> Default: `true`                                                                                                                                                                                                                                                                                                                     |
| `prompt`                        | The base prompt that is used to generate the summary. <br /> Default: See [action.yml](action.yml#L36-L47)                                                                                                                                                                                                                                                                                                                                       |
| `prompt-addition`               | The addition to the base prompt that is used to generate the summary.                                                                                                                                                                                                                                                                                                                                                                            |
| `include-files`                 | A list of patterns that match the files of the PR that should be included in the summary (comma or newline separated and supports glob patterns). <br /> Default: `**`                                                                                                                                                                                                                                                                           |
| `exclude-files`                 | A list of patterns that match the files of the PR that should be excluded from the summary (comma or newline separated and supports glob patterns). <br /> Default: none                                                                                                                                                                                                                                                                         |
| `include-context-files`         | A list of patterns for files that should always be included as context, regardless of whether the PR affects them (comma or newline separated and supports glob patterns). <br /> Default: none                                                                                                                                                                                                                                                  |
| `exclude-context-files`         | A list of patterns for files that should excluded from context, regardless of whether the PR affects them (comma or newline separated and supports glob patterns).                                                                                                                                                                                                                                                                               |
| `header-text`                   | Text to be inserted before the summary.                                                                                                                                                                                                                                                                                                                                                                                                          |
| `footer-text`                   | Text to be inserted after the summary.                                                                                                                                                                                                                                                                                                                                                                                                           |
| `previous-results`              | Define what to do with previous results. Possible values are `keep`, `hide`, or `delete`. <br /> Default: `hide`                                                                                                                                                                                                                                                                                                                                 |
| `pr-number`                     | The number of the pull request for which the summary should be created. <br /> Default: `${{ github.event.number }}`                                                                                                                                                                                                                                                                                                                             |
| `base-sha`                      | The hash of the commit representing the code before changes. Used as the starting point in comparison.                                                                                                                                                                                                                                                                                                                                           |
| `head-sha`                      | The hash of the commit representing the code after changes. Used as the end point in comparison.                                                                                                                                                                                                                                                                                                                                                 |
| `owner`                         | The owner of the repository for which the summary should be created. <br /> Default: `${{ github.repository_owner }}`                                                                                                                                                                                                                                                                                                                            |
| `repo`                          | The name of the repository for which the summary should be created. <br /> Default: `${{ github.event.repository.name }}`                                                                                                                                                                                                                                                                                                                        |
| `github-api-url`                | The GitHub base URL will be automatically set to the correct value from the GitHub context variable. <br /> Default: `${{ github.api_url }}`                                                                                                                                                                                                                                                                                                     |

Output parameters of the action:

| Parameter     | Description                                                         |
| ------------- | ------------------------------------------------------------------- |
| `summary`     | The AI-generated summary (Markdown format)                          |
| `displayText` | Contains the header, summary, and footer text.                      |
| `commentId`   | The ID of the created GitHub comment (for `display-mode` `comment`) |

## Advanced Examples

### Trigger on review request

Execute the action when a [pull request review is requested](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#pull_request) for a specific user:

```yaml
name: AI-assisted
on:
  pull_request:
    types: [review_requested]

jobs:
  review:
    name: PR Review
    if: github.event.requested_reviewer.login == 'my-orgs-serviceuser'
    runs-on: [solinas]
    steps:
      - uses: SAP/ai-assisted-github-actions/pr-summary@v3
        with:
          user-token: ${{ secrets.MY_ORGS_SERVICE_USER_TOKEN }}
          aicore-service-key: ${{ secrets.AICORE_SERVICE_KEY }}
```

- The `if` condition is used to filter the review requests to a specific user (e.g., `my-orgs-serviceuser`).
- The `user-token` is the [GitHub personal access token](https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens) of the user who will create the comment and should match the user token of the user specified in the `if` condition.
- The `aicore-service-key` should be a valid service key for your _SAP AI Core_ service instance.

### Exclude/Include Specific Files

#### Exclude certain files of the PR from the summary:

```yaml
- uses: SAP/ai-assisted-github-actions/pr-summary@v3
  with:
    exclude-files: package-lock.json, *-lock.json
```

```yaml
- uses: SAP/ai-assisted-github-actions/pr-summary@v3
  with:
    exclude-files: |
      package-lock.json
      *-lock.json
```

- The pattern provided in `exclude-files` excludes all files with `package-lock.json` and `*-lock.json` in the name.

#### Include only specific files of the PR in the summary:

```yaml
- uses: SAP/ai-assisted-github-actions/pr-summary@v3
  with:
    include-files: "**/*.ts, **/*.js"
```

```yaml
- uses: SAP/ai-assisted-github-actions/pr-summary@v3
  with:
    include-files: |
      **/*.ts
      **/*.js
```

- The pattern provided in `include-files` includes all files with `.ts` and `.js` extensions.

### Exclude Specific Actors

Prevent the action from being triggered by specific actors like bots:

```yaml
jobs:
  summary:
    name: PR Summary
    if: github.actor != 'ospo-renovate[bot]'
    runs-on: [solinas]
    steps:
      - uses: SAP/ai-assisted-github-actions/pr-summary@v3
        with:
```

- The `if` [condition](https://docs.github.com/en/actions/writing-workflows/choosing-when-your-workflow-runs/using-conditions-to-control-job-execution) makes sure the step only runs if it's not started by the [`ospo-renovate[bot]`](https://github.tools.sap/github-apps/ospo-renovate) user. Otherwise, the job will be marked as skipped.

### Influence the Display Mode

#### Append the summary to the PR description instead of posting it as a comment:

```yaml
- uses: SAP/ai-assisted-github-actions/pr-summary@v3
  with:
    display-mode: append
    header-text: "## AI Summary\n"
    footer-text: "\n---\n"
```

- The `display-mode` parameter is set to `append` to add the summary to the PR description.
- The `header-text` parameter is set to a markdown header to distinguish the summary from the default PR text.
- The `footer-text` parameter is set to a markdown horizontal rule to separate the summary from the default PR text.

#### Utilize output for further actions

```yaml
jobs:
  summary-and-review:
    name: PR Summary & Review
    runs-on: [solinas]
    steps:
      - uses: SAP/ai-assisted-github-actions/pr-summary@v3
        id: summary
        with:
          aicore-service-key: ${{ secrets.AICORE_SERVICE_KEY }}
          display-mode: none
      - uses: SAP/ai-assisted-github-actions/pr-review@v3
        with:
          aicore-service-key: ${{ secrets.AICORE_SERVICE_KEY }}
          header-text: |
            ## AI Summary
            ${{ steps.summary.outputs.displayText }}
            ---
```

- The `display-mode` parameter is set to `none` to prevent the summary from being displayed as a comment.
- The `displayText` output parameter is used to pass the summary to the next action for further processing.

### Custom AI Model or Prompt

#### Specify a custom AI model:

```yaml
- uses: SAP/ai-assisted-github-actions/pr-summary@v3
  with:
    model: anthropic--claude-3.5-sonnet
```

- The `model` parameter can be set to the executable ID of the [available generative AI models](https://me.sap.com/notes/3437766/E).

#### Extend or customize the prompt:

```yaml
- uses: SAP/ai-assisted-github-actions/pr-summary@v3
  with:
    prompt-addition: |
      At the end of the summary, include a whimsical, short poem to celebrate the changes. Feel free to use emojis where relevant.
```

- The `prompt-addition` parameter can be set to a custom prompt that will be appended to the base prompt.

#### Create a fully custom prompt:

```yaml
- uses: SAP/ai-assisted-github-actions/pr-summary@v3
  with:
    prompt: |
      Create a summary of the pull request. 
      Include the changes, the reason for the changes, and the impact of the changes.
```

- The `prompt` parameter can be set to a custom prompt that will be used to generate the summary.

## Contribute

This project is an [InnerSource](https://go.sap.corp/innersource) initiative. Contributions are welcome!

---

> Remember, no AI can replace the keen eye of a seasoned developer... yet.
